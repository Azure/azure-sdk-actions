# Check Enforcer

## Why did we create Check Enforcer?

The Azure SDK team maintains reusable libraries that developers use to access Azure services. These libraries are grouped by together into a repository for each language/runtime. For example there is a repository for [Java](https://github.com/azure/azure-sdk-for-java), [.NET](https://github.com/azure/azure-sdk-for-net), [Python](https://github.com/azure/azure-sdk-for-python) and [JavaScript](https://github.com/azure/azure-sdk-for-javascript) - just to name a few.

Each repository contains a large number of separate libraries. Even though together these libraries constitute a single SDK, they ship separately on their own individual cadence as the underlying service evolves. As a result we have separate build and release pipelines for say the KeyVault and the Event Hubs libraries in each repository.

Whilst Checks in GitHub are awesome, one of the limitations when setting up required checks is that you cannot make them required for just one specific path. We don't want to build all libraries for every checkin (that would take a long time and needlessly block teams if other libraries were having build reliability issues) - so we needed a way to work around it.

Check Enforcer is our solution. We use the built-in triggering w/ path filter options within Azure Pipelines (Check Enforcer is CI tool agnostic however) to control when a pipeline triggers, and we just use Check Enforcer to block until all triggered pipelines pass successfully. Each of those libraries can be optional - and you just make Check Enforcer the only required check in the repo.

## Enabling Check Enforcer for a Repository

1. Copy the following workflow files into your repo and check them into the main branch:
    - `../example-workflow.yaml` ([link](https://github.com/Azure/azure-sdk-actions/blob/main/example-workflow.yaml))
1. Create a pull request so that one of the above actions will run and post a status.
1. Add a new branch protection rule in your repository settings: `https://github.com/<org>/<repo>/settings/branches`
    - Enter the default branch or desired branch name pattern.
    - Check `Require status checks to pass before merging`, search for the status check
      `https://aka.ms/azsdk/checkenforcer` and select it.
    - Save changes

## Usage

Check Enforcer runs within a github actions context, and triggers off two types of events: `check_suite completed` and `issue_comment created`.

- `check_suite completed` behavior: When a pull request is created, github will show a pending status check for check enforcer based on the branch protection rule configured for the default branch (`main`). A check_suite is the github representation of all `check_runs` (e.g. pipeline jobs) associated with the head commit of the pull request branch. When all registered `check_runs` are completed, a `check_suite completed` event is triggered. The check enforcer github action will run at this time, evaluate the state of the `check_suite` and POST the corresponding state to the check enforcer `statuses` API endpoint for the pull request.
- `issue_comment created` behavior: When a comment is added to the pull request, check enforcer will check if that comment is a supported [command](#pr-comment-commands). If so, it will perform the corresponding behavior (reset, evaluate or override).

**NOTE:** Currently check enforcer will only handle events for check suites generated by the `Azure Pipelines` github
app.

## PR Comment Commands

Check Enforcer supports a limited number of commands which can by issued via PR comments. For example if Check Enforcer appears to be stuck you can add a comment as follows to re-evaluate the pull request checks:

```
/check-enforcer evaluate
```

From time to time Check Enforcer may be blocking a merge because no-check runs are appropriate for the PR, in these cases you can use the following command Check Enforcer rules and park the commit as successful:

```
/check-enforcer override
```

These are the only commands that Check Enforcer supports at this time.

## Need Help?

Check Enforcer is built primarily for use by the Azure SDK Engineering Systems teams for use within their mono-repositories. But we are happy for others to pick it up and start using it. If you have any issues feel free to log an issue on this GitHub repository and we'll do our best to help you out.

## Contributing

Got an idea for Check Enforcer? Great - a good way to start contributing is by creating an issue and discussing with us what you want to do. We are always happy to review unsolicited pull requests and if they match our goals for Check Enforcer we'll work with you to get it merged - but its probably better if you give us a heads up on what you want to achieve first.
